# Event Model

The main output from the diagnostic engine is an event log. The event log is a stream of event records. Event records are instances of event types. Event types define schema for events. 
This schema is a contract between diagnostic engine and its clients. Clients can read 
the schema to understand the event record structure. Because the event record is represented in 
the JSON syntax, it is possible to process the event record event without knowing about its schema. 
To support this case, all event records contain mandatory fields and event specific fields. 

## Event Type Definition
Each event type defines its own schema, which provide additional information about event data structure. Event type definition not only defines extra fields, but can also provide default values for selected fields. 

The event type definition is written in the YAML syntax. The YAML schema validator of the event type definition is as follows:

```yaml
---
# schema validator for the event type definition:
event-type:
  id:           int()   # event-type-id
  name:         str()   # name of the event
  provider:     str()   # name of the default provider
  description:  str()   # description of the event
  severity:     enum('error','warning','info')   # default severity of the event
  message:      str()   # string with placeholders used to generate the message when the event is emmited
  event-fields: list(include('event-field'))

# schema validator for a single field type:
event-field:
  name: str()           # name of the field, it can be used to reference this fields, e.g., in message string.
  ref:  int()           # identification of the field within the event record 
  type: str()           # one of the supported type
  description: str()    # field description for the purpose of generating documentation
---
```

An example event type definition can be as follows: 

```yaml
---
event-type:
  id:           33012
  name:         dns_no_response_error
  provider:     DNS
  description:  "DNS server did not reply to the legitimate query"
  severity:     error
  message:      "DNS Server {dns-server} did not reply to query '{dns-query-string}' ({dns-query-id})."
  event-fields:
    - name: dns-client
      ref: 1
      type: string
      description: IP address of DNS client.
    - name: dns-server
      ref: 2
      type: string
      description: IP address of DNS server.
    - name: dns-query-id
      ref: 3
      type: string
      description: Transaction ID found in DNS query.
    - name: dns-query-string
      ref: 4
      type: string
      description: String representation of the DNS query. 
...
```

## Event Severity
Events are classified into different classes based their severity. The basic classes are
error, warning and information. 

| Event Level   | Description  |
| ------------- |:-------------|
| Error         | An event that indicates that a significant problem was found. This problem may be the reasons that hamper service functionality. |
| Warning       | An event that is not necessarily significant, but may indicate a possible future problem.       |  
| Information   | An event that describes the successful operation of an application or service.      |  

## Event Record
An event record is a single piece of information generated by the diagnostic engine. The record
is written to the event log and it is consumed by clients of diagnostic module. 
Event record has JSON representation. All event records contain the following mandatory fields:

| Field            | Type                  | Description                                   |
| ---------------- | --------------------- | --------------------------------------------- |
| timestamp        | UInt64                | Amount of milliseconds since UNIX epoch.      |
| provider         | String                | Specifies the name of the provider that generated the event record. |
| severity         | Enum of EventSeverity | The level of severity of the current record.  |
| event-type-id    | UInt32                | The unique identification of the record type. |
| event-record-id  | Guid                  | The unique identificator of the event record. |
| related-events   | Array of Guid         | An array of identifiers of related events.    |
| message          | String                | Human readable message of the event record.   |

Depending on the event type, the record also contains fields specific to the event. 
These fields are defined using Event Schema.

Following block shows an example of the event record that represents a DNS error:
```json
{
    "timestamp"     : 1528449907344,
    "provider"      : "DNS",
    "severity"      : "error",    
    "event-type-id" : 33012,
    "event-record-id" : "5a3f79ae-6afd-11e8-adc0-fa7ae01bbebc",
    "related-events" : [],
    "message" : "DNS Server 147.229.9.11 did not reply to query 'captive.g.aaplimg.com: type A, class IN' (0xbafa).",
    "dns-client" : "192.168.131.10",
    "dns-server" : "147.229.9.11",
    "dns-query-id" : "0xbafa",
    "dns-string" : "captive.g.aaplimg.com: type A, class IN"
}
```